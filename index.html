<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Departures Board</title>
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#111;
      --grid:#2a2a2a;
      --text:#f2f2f2;
      --yellow:#ffd400;
      --muted:#b8b8b8;
      --danger:#ff5c5c;
      --warn:#ffcc66;
      --ok:#7CFF7C;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:linear-gradient(180deg,#0a0a0a,#000);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      background: linear-gradient(180deg,#1b1b1b,#0f0f0f);
      border: 1px solid #2b2b2b;
      border-radius: 14px 14px 0 0;
    }
    .title{
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:800;
      letter-spacing:0.08em;
    }
    .badge{
      width:34px;height:34px;
      border-radius:8px;
      background:var(--yellow);
      display:grid;place-items:center;
      color:#000;font-weight:900;
    }
    .meta{
      text-align:right;
      font-size: 12px;
      color: var(--muted);
      line-height:1.4;
    }
    .board{
      background: var(--panel);
      border: 1px solid #2b2b2b;
      border-top: 0;
      border-radius: 0 0 14px 14px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 20px;
      letter-spacing:0.04em;
    }
    thead th{
      text-align:left;
      padding: 14px 16px;
      background: #0e0e0e;
      color:#cfcfcf;
      border-bottom:1px solid #2b2b2b;
      font-size: 14px;
      letter-spacing:0.14em;
      text-transform:uppercase;
    }
    tbody td{
      padding: 12px 16px;
      border-bottom: 1px solid var(--grid);
      color: var(--yellow);
      white-space:nowrap;
    }
    tbody tr:last-child td{ border-bottom:0; }
    td.col-remarks{
      color:#eaeaea;
      font-weight:700;
    }
    .status{
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 14px;
      letter-spacing:0.08em;
      display:inline-block;
      border:1px solid #333;
      background:#0c0c0c;
      color:#eaeaea;
    }
    .status.cancelled{ color: var(--danger); border-color:#5a2222; }
    .status.delayed{ color: var(--warn); border-color:#5a4a22; }
    .status.ontime{ color: var(--ok); border-color:#235a23; }
    .footer{
      display:flex;
      justify-content:space-between;
      padding: 12px 16px;
      border-top:1px solid #2b2b2b;
      color: var(--muted);
      font-size: 12px;
      background:#0c0c0c;
    }
    .error{
      padding: 14px 16px;
      color: #ffb3b3;
      border-top:1px solid #2b2b2b;
      background:#140808;
      font-size: 14px;
    }

    /* ===== PANTALLA DE PUBLICIDAD ===== */
    #adScreen{
      position: fixed;
      inset: 0;
      background: #000;
      display: none;
      z-index: 9999;
    }
    #adScreen img{
      width: 100vw;
      height: 100vh;
      object-fit: cover; /* cambia a 'contain' si no quieres recorte */
    }
  </style>
</head>

<body>
  <!-- Pantalla 1: Vuelos -->
  <div id="boardScreen">
    <div class="wrap">
      <div class="header">
        <div class="title">
          <div class="badge">✈</div>
          <div>DEPARTURES</div>
        </div>
        <div class="meta">
          <div id="now"></div>
          <div>Auto-refresh: <span id="refreshEvery"></span>s</div>
        </div>
      </div>

      <div class="board">
        <table>
          <thead>
            <tr>
              <th style="width:120px;">TIME</th>
              <th>DESTINATION</th>
              <th style="width:160px;">FLIGHT</th>
              <th style="width:110px;">GATE</th>
              <th style="width:260px;">REMARKS</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <div class="footer">
          <div>Last update: <span id="lastUpdate">—</span></div>
          <div>Showing: <span id="count">0</span> flights</div>
        </div>
        <div id="err" class="error" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Pantalla 2/3: Publicidad -->
  <div id="adScreen">
    <img id="adImage" alt="Publicidad" />
  </div>

  <script>
    // 1) LINK CSV PUBLICADO
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1QgLSEEkyRrwFcH3cYcnyDCD_-mYjRJRIGw_gQ9a-UVE/edit?gid=0#gid=0";

    // 2) Ajusta cada cuánto refresca (segundos)
    const REFRESH_SECONDS = 30;

    // 3) Opcional: filtrar solo por la fecha de hoy (true/false)
    const FILTER_TODAY = false;

    const elRows = document.getElementById("rows");
    const elErr = document.getElementById("err");
    const elLast = document.getElementById("lastUpdate");
    const elCount = document.getElementById("count");
    document.getElementById("refreshEvery").textContent = REFRESH_SECONDS;

    function tickClock(){
      const d = new Date();
      document.getElementById("now").textContent =
        d.toLocaleString(undefined, { weekday:"short", year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    setInterval(tickClock, 1000);
    tickClock();

    function normalizeStatus(txt){
      const t = (txt || "").toString().trim().toUpperCase();
      if (t.includes("CANCEL")) return {cls:"cancelled", label:t};
      if (t.includes("DELAY")) return {cls:"delayed", label:t};
      if (t.includes("ON TIME") || t.includes("ONTIME")) return {cls:"ontime", label:t};
      return {cls:"", label:t || "—"};
    }

    // Parser CSV simple (soporta comillas)
    function parseCSV(text){
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i=0; i<text.length; i++){
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"'){
          cur += '"'; i++;
        } else if (ch === '"'){
          inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes){
          row.push(cur); cur = "";
        } else if ((ch === '\n' || ch === '\r') && !inQuotes){
          if (cur.length || row.length){
            row.push(cur); cur = "";
            if (ch === '\r' && next === '\n') i++;
            rows.push(row);
            row = [];
          }
        } else {
          cur += ch;
        }
      }
      if (cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }
      return rows;
    }

    function toISODateLocal(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function safe(v){ return (v ?? "").toString().trim(); }

    function sortByTime(a,b){
      return safe(a.std).localeCompare(safe(b.std));
    }

    function render(flights){
      elRows.innerHTML = "";
      for (const f of flights){
        const status = normalizeStatus(f.remarks);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${safe(f.std) || "—"}</td>
          <td>${safe(f.destination) || "—"}</td>
          <td>${safe(f.flight) || "—"}</td>
          <td>${safe(f.gate) || "—"}</td>
          <td class="col-remarks"><span class="status ${status.cls}">${status.label}</span></td>
        `;
        elRows.appendChild(tr);
      }
      elCount.textContent = flights.length;
    }

    async function load(){
      try{
        elErr.style.display = "none";
        const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
        const res = await fetch(url);
        if (!res.ok) throw new Error("No se pudo cargar el CSV: " + res.status);

        const csvText = await res.text();
        const data = parseCSV(csvText);

        if (!data.length) throw new Error("CSV vacío.");

        const headers = data[0].map(h => h.trim().toLowerCase());
        const idx = (name) => headers.indexOf(name);

        const required = ["date","std","destination","flight","gate","remarks"];
        for (const r of required){
          if (idx(r) === -1) throw new Error(`Falta columna "${r}" en el Sheet.`);
        }

        const flights = data.slice(1)
          .filter(r => r.some(c => (c||"").trim() !== ""))
          .map(r => ({
            date: r[idx("date")],
            std: r[idx("std")],
            destination: r[idx("destination")],
            flight: r[idx("flight")],
            gate: r[idx("gate")],
            remarks: r[idx("remarks")],
          }));

        const today = toISODateLocal(new Date());
        const filtered = FILTER_TODAY ? flights.filter(f => safe(f.date) === today) : flights;

        filtered.sort(sortByTime);
        render(filtered);

        elLast.textContent = new Date().toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        localStorage.setItem("lastFlights", JSON.stringify(filtered));
        localStorage.setItem("lastUpdate", elLast.textContent);

      } catch (e){
        const saved = localStorage.getItem("lastFlights");
        if (saved){
          render(JSON.parse(saved));
          elLast.textContent = localStorage.getItem("lastUpdate") || "—";
        }
        elErr.textContent = "Error: " + (e?.message || e);
        elErr.style.display = "block";
      }
    }

    // ===== CARRUSEL DE PANTALLAS =====
    const boardScreen = document.getElementById("boardScreen");
    const adScreen = document.getElementById("adScreen");
    const adImage = document.getElementById("adImage");

    // Asegúrate que existan estos archivos:
    // flight-board/ads/ad1.png
    // flight-board/ads/ad2.png
    const playlist = [
      { type: "board", duration: 30000 },                // vuelos 30s
      { type: "ad", src: "ads/ad1.jpg", duration: 10000 }, // publicidad 1 (10s)
      { type: "ad", src: "ads/ad2.jpg", duration: 10000 }, // publicidad 2 (10s)
    ];

    let current = 0;
    let timer = null;

    function showBoard(){
      adScreen.style.display = "none";
      boardScreen.style.display = "block";
    }

    function showAd(src){
      boardScreen.style.display = "none";
      adScreen.style.display = "block";
      adImage.src = src;
    }

    function runPlaylist(){
      if (timer) clearTimeout(timer);

      const item = playlist[current];
      if (item.type === "board") showBoard();
      else showAd(item.src);

      timer = setTimeout(() => {
        current = (current + 1) % playlist.length;
        runPlaylist();
      }, item.duration);
    }

    // Arranque
    load();
    setInterval(load, REFRESH_SECONDS * 1000);
    runPlaylist();
  </script>
</body>
</html>

